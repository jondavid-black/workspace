apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdlc-pod
  labels:
    app: sdlc-pod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sdlc-pod
  template:
    metadata:
      labels:
        app: sdlc-pod
    spec:
      containers:
        - name: vscode
          image: codercom/code-server:latest
          args: ["--bind-addr", "0.0.0.0:8084", "--auth", "password", "/workspace"]
          workingDir: /workspace
          ports:
            - containerPort: 8084
          env:
            - name: PASSWORD
              value: "password"
          volumeMounts:
            - name: shared-data
              mountPath: /workspace

        - name: syson-db
          image: postgres:15
          command: ["docker-entrypoint.sh"]
          args: ["-p", "5433"]
          env:
            - name: POSTGRES_DB
              value: postgres
            - name: POSTGRES_USER
              value: username
            - name: POSTGRES_PASSWORD
              value: password
          volumeMounts:
            - name: shared-data
              mountPath: /var/lib/postgresql/data
              subPath: syson-db

        - name: syson-app
          image: eclipsesyson/syson:v2025.12.0
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://localhost:5433/postgres
            - name: SPRING_DATASOURCE_USERNAME
              value: username
            - name: SPRING_DATASOURCE_PASSWORD
              value: password
            - name: SIRIUS_COMPONENTS_CORS_ALLOWEDORIGINPATTERNS
              value: "*"
            - name: SERVER_PORT
              value: "8081"
            - name: SERVER_ADDRESS
              value: "0.0.0.0"
          volumeMounts:
            - name: shared-data
              mountPath: /data

        - name: penpot-frontend
          image: penpotapp/frontend:latest
          ports:
            - containerPort: 8080
          env:
            - name: PENPOT_FLAGS
              value: "disable-email-verification enable-smtp enable-prepl-server disable-secure-session-cookies"
            - name: PENPOT_HTTP_SERVER_MAX_BODY_SIZE
              value: "31457280"
            - name: PENPOT_HTTP_SERVER_MAX_MULTIPART_BODY_SIZE
              value: "367001600"
            - name: PENPOT_BACKEND_URI
              value: "http://localhost:6060"
            - name: PENPOT_EXPORTER_URI
              value: "http://localhost:6061"
          volumeMounts:
            - name: shared-data
              mountPath: /opt/data/assets
              subPath: penpot-assets

        - name: penpot-backend
          image: penpotapp/backend:latest
          ports:
            - containerPort: 6060
          env:
            - name: PENPOT_FLAGS
              value: "disable-email-verification enable-smtp enable-prepl-server disable-secure-session-cookies"
            - name: PENPOT_PUBLIC_URI
              value: "http://localhost:8080"
            - name: PENPOT_HTTP_SERVER_MAX_BODY_SIZE
              value: "31457280"
            - name: PENPOT_HTTP_SERVER_MAX_MULTIPART_BODY_SIZE
              value: "367001600"
            - name: PENPOT_SECRET_KEY
              value: "change-this-insecure-key"
            - name: PENPOT_DATABASE_URI
              value: "postgresql://localhost:5432/penpot"
            - name: PENPOT_DATABASE_USERNAME
              value: "penpot"
            - name: PENPOT_DATABASE_PASSWORD
              value: "penpot"
            - name: PENPOT_REDIS_URI
              value: "redis://localhost:6379/0"
            - name: PENPOT_OBJECTS_STORAGE_BACKEND
              value: "fs"
            - name: PENPOT_OBJECTS_STORAGE_FS_DIRECTORY
              value: "/opt/data/assets"
            - name: PENPOT_TELEMETRY_ENABLED
              value: "true"
            - name: PENPOT_SMTP_DEFAULT_FROM
              value: "no-reply@example.com"
            - name: PENPOT_SMTP_HOST
              value: "localhost"
            - name: PENPOT_SMTP_PORT
              value: "1025"
          volumeMounts:
            - name: shared-data
              mountPath: /opt/data/assets
              subPath: penpot-assets

        - name: penpot-exporter
          image: penpotapp/exporter:latest
          ports:
            - containerPort: 6061
          env:
            - name: PENPOT_SECRET_KEY
              value: "change-this-insecure-key"
            - name: PENPOT_PUBLIC_URI
              value: "http://localhost:8080"
            - name: PENPOT_REDIS_URI
              value: "redis://localhost:6379/0"

        - name: penpot-postgres
          image: postgres:15
          env:
            - name: POSTGRES_INITDB_ARGS
              value: "--data-checksums"
            - name: POSTGRES_DB
              value: penpot
            - name: POSTGRES_USER
              value: penpot
            - name: POSTGRES_PASSWORD
              value: penpot
          volumeMounts:
            - name: shared-data
              mountPath: /var/lib/postgresql/data
              subPath: penpot-db-v3

        - name: penpot-valkey
          image: valkey/valkey:8.1
          env:
            - name: VALKEY_EXTRA_FLAGS
              value: "--maxmemory 128mb --maxmemory-policy volatile-lfu"

        - name: penpot-mailcatch
          image: sj26/mailcatcher:latest
          ports:
            - containerPort: 1080
            - containerPort: 1025

        - name: collabora-code
          image: collabora/code:latest
          securityContext:
            capabilities:
              add:
                - FOWNER
                - MKNOD
                - SETGID
                - SETUID
                - SYS_CHROOT
          ports:
            - containerPort: 9980
          env:
            - name: extra_params
              value: "--o:ssl.enable=false --o:ssl.termination=true --o:mount_namespaces=false"
            - name: aliasgroup1
              value: "http://localhost:9980"
          volumeMounts:
            - name: shared-data
              mountPath: /workspace
          readinessProbe:
            httpGet:
              path: /
              port: 9980
            initialDelaySeconds: 30
            periodSeconds: 10

        - name: opencode
          image: ghcr.io/anomalyco/opencode:latest
          command: ["opencode"]
          args: ["web", "--hostname", "0.0.0.0", "--port", "8083"]
          workingDir: /workspace
          ports:
            - containerPort: 8083
          volumeMounts:
            - name: shared-data
              mountPath: /workspace

        - name: ttyd
          image: tsl0922/ttyd:latest
          command: ["ttyd"]
          args: ["-i", "0.0.0.0", "-p", "8085", "-W", "-w", "/workspace", "bash"]
          workingDir: /workspace
          ports:
            - containerPort: 8085
          volumeMounts:
            - name: shared-data
              mountPath: /workspace

      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: sdlc-shared-data
