apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdlc-pod
  labels:
    app: sdlc-pod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sdlc-pod
  template:
    metadata:
      labels:
        app: sdlc-pod
    spec:
      containers:
        - name: vscode
          image: codercom/code-server:latest
          ports:
            - containerPort: 8080
          env:
            - name: PASSWORD
              value: "password"
          volumeMounts:
            - name: shared-data
              mountPath: /home/coder/project
        
        - name: syson-db
          image: postgres:15
          command: ["docker-entrypoint.sh"]
          args: ["-p", "5433"]
          env:
            - name: POSTGRES_DB
              value: postgres
            - name: POSTGRES_USER
              value: username
            - name: POSTGRES_PASSWORD
              value: password
          volumeMounts:
            - name: shared-data
              mountPath: /var/lib/postgresql/data
              subPath: syson-db

        - name: syson-app
          image: eclipsesyson/syson:v2025.12.0
          ports:
            - containerPort: 8081
          env:
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://localhost:5433/postgres
            - name: SPRING_DATASOURCE_USERNAME
              value: username
            - name: SPRING_DATASOURCE_PASSWORD
              value: password
            - name: SIRIUS_COMPONENTS_CORS_ALLOWEDORIGINPATTERNS
              value: "*"
            - name: SERVER_PORT
              value: "8081"
          volumeMounts:
            - name: shared-data
              mountPath: /data

        - name: penpot-frontend
          image: python:3.12-slim
          command: ["python", "-m", "http.server", "8082"]
          ports:
            - containerPort: 8082
          volumeMounts:
            - name: shared-data
              mountPath: /data

        - name: penpot-backend
          image: penpotapp/backend:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              until nc -z localhost 5432; do
                echo "waiting for postgres..."
                sleep 2
              done
              /update.sh # Penpot often has an update script for migrations
              /run.sh
          ports:
            - containerPort: 6060
          env:
            - name: PENPOT_DATABASE_URI
              value: "postgresql://penpot:penpot@localhost/penpot"
            - name: PENPOT_REDIS_URI
              value: "redis://localhost/0"
          volumeMounts:
            - name: shared-data
              mountPath: /data

        - name: opencode
          image: ghcr.io/anomalyco/opencode:latest
          command: ["opencode"]
          args: ["web", "--hostname", "0.0.0.0", "--port", "8083"]
          ports:
            - containerPort: 8083
          volumeMounts:
            - name: shared-data
              mountPath: /data

        # Supporting containers for PenPot
        - name: redis
          image: redis:7
        
        - name: postgres
          image: postgres:15
          env:
            - name: POSTGRES_DB
              value: penpot
            - name: POSTGRES_USER
              value: penpot
            - name: POSTGRES_PASSWORD
              value: penpot
          volumeMounts:
            - name: shared-data
              mountPath: /var/lib/postgresql/data
              subPath: penpot-db

      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: sdlc-shared-data
